name: Fabric - Git Sync Full

on:
  workflow_dispatch:

jobs:
  sync-git:
    runs-on: ubuntu-latest

    steps:
      - name: üßë‚Äçüíª Login with device code (user identity)
        run: |
          az login --use-device-code

      - name: üîê Get Fabric access token
        id: fabric-auth
        run: |
          TOKEN=$(az account get-access-token \
            --resource=https://api.fabric.microsoft.com \
            --query accessToken -o tsv)
          echo "token=$TOKEN" >> $GITHUB_OUTPUT

      - name: üìä Get Git status for remote/commit info
        id: git-status
        env:
          FABRIC_TOKEN: ${{ steps.fabric-auth.outputs.token }}
          WORKSPACE_ID: ${{ secrets.DEV_WORKSPACE_ID }}
        run: |
          echo "üì• Fetching Git status..."
          RESPONSE=$(curl -s -X GET "https://api.fabric.microsoft.com/v1/workspaces/$WORKSPACE_ID/git/status" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json")

          echo "$RESPONSE"

          REMOTE_COMMIT_HASH=$(echo $RESPONSE | jq -r '.gitSyncDetails.remoteCommitHash')
          WORKSPACE_HEAD=$(echo $RESPONSE | jq -r '.gitSyncDetails.head')

          echo "REMOTE_COMMIT_HASH=$REMOTE_COMMIT_HASH" >> $GITHUB_ENV
          echo "WORKSPACE_HEAD=$WORKSPACE_HEAD" >> $GITHUB_ENV

      - name: üîÅ Update workspace from Git
        env:
          FABRIC_TOKEN: ${{ steps.fabric-auth.outputs.token }}
          WORKSPACE_ID: ${{ secrets.DEV_WORKSPACE_ID }}
          REMOTE_COMMIT_HASH: ${{ env.REMOTE_COMMIT_HASH }}
          WORKSPACE_HEAD: ${{ env.WORKSPACE_HEAD }}
        run: |
          echo "üîÑ Syncing with commit: $REMOTE_COMMIT_HASH"

          curl -X PATCH "https://api.fabric.microsoft.com/v1/workspaces/$WORKSPACE_ID/git/updateFromGit" \
            -H "Authorization: Bearer $FABRIC_TOKEN" \
            -H "Content-Type: application/json" \
            --data "{
              \"remoteCommitHash\": \"$REMOTE_COMMIT_HASH\",
              \"workspaceHead\": \"$WORKSPACE_HEAD\",
              \"conflictResolution\": \"clientWins\",
              \"options\": {
                \"includeSemanticModel\": true
              }
            }"
